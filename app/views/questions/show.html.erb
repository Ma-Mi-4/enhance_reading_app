<% content_for :body_attributes do %> data-has-timer="true" data-turbo="false" <% end %>

<meta name="turbo-cache-control" content="no-cache">

<h1><%= @questions_data["title"] %></h1>

<p><%= @questions_data["text"] %></p>

<%= form_with url: (@review ? review_explanation_question_path(@id) : explanation_question_path(@id, level: (params[:level] || current_user.level))),
              method: :post,
              local: true,
              html: { id: "question_form" }, 
              data: { turbo: false } do |f| %>

  <div id="timer" style="font-size: 24px;">00:00</div>
  <%= hidden_field_tag :study_seconds, 0, id: "study_seconds" %>
  <%= hidden_field_tag :accuracy, 0, id: "accuracy_field_questions" %>

  <% @questions_data["questions"].each_with_index do |q, index| %>
    <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc;">
      <p><strong>Question <%= index + 1 %>:</strong> <%= q["question_text"] %></p>
      <ul>
        <% q["choices_text"].each_with_index do |choice, i| %>
          <li>
            <input type="radio" name="q<%= index %>" value="<%= i %>" id="q<%= index %>_choice<%= i %>">
            <label for="q<%= index %>_choice<%= i %>"><%= choice %></label>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>

<script>
console.log("Quiz script loaded");

let timerInterval;
let totalSeconds = 0;

function startTimer() {
  console.log("startTimer() called");
  timerInterval = setInterval(() => {
    totalSeconds++;
    document.getElementById("study_seconds").value = totalSeconds;
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    document.getElementById("timer").textContent =
      String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");

     console.log("Study seconds:", totalSeconds);
  }, 1000);
}

function stopTimer() {
  console.log("stopTimer() called");
  clearInterval(timerInterval);
}

function calculateAccuracy() {
  const correctIndexes = <%= raw @questions_data["questions"].map { |q| q["correct_choice_index"] }.to_json %>;
  console.log("correctIndexes:", correctIndexes);

  let correctCount = 0;
  const form = document.getElementById("question_form");

  for (let i = 0; i < correctIndexes.length; i++) {
    const selected = form.querySelector(`input[name="q${i}"]:checked`);
    if (selected) {
      if (parseInt(selected.value) === correctIndexes[i]) correctCount++;
    } else {
      console.log(`Question ${i} is not answered`);
    }
  }

  const accuracy = correctCount / correctIndexes.length;
  document.getElementById("accuracy_field_questions").value = accuracy;

  console.log("Correct answers:", correctCount);
  console.log("Total questions:", correctIndexes.length);
  console.log("Accuracy calculated:", accuracy);
  console.log("Study seconds at submit:", totalSeconds);
}

function initQuiz() {
  console.log("initQuiz called");
  startTimer();

  const form = document.getElementById("question_form");
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      console.log("Form submit event triggered");
      stopTimer();
      calculateAccuracy();

      console.log("Accuracy field value before submit:", document.getElementById("accuracy_field_questions").value);
      form.submit();
    });
  }
}

document.addEventListener("DOMContentLoaded", initQuiz);
document.addEventListener("turbo:load", initQuiz);
</script>


  <%= f.submit "解説を見る" %>
<% end %>
