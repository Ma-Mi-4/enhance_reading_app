<% content_for :body_attributes do %> data-has-timer="true" <% end %>

<meta name="turbo-cache-control" content="no-cache">

<h1><%= @questions_data["title"] %></h1>

<p><%= @questions_data["text"] %></p>

<%= form_with url: (@review ? review_explanation_question_path(@id) : explanation_question_path(@id, level: (params[:level] || current_user.level))),
              method: :post,
              local: true,
              data: { turbo: false },
              onsubmit: "stopTimer()" do |f| %>

  <div id="timer" style="font-size: 24px;">00:00</div>
  <%= hidden_field_tag :study_seconds, 0, id: "study_seconds" %>

  <% @questions_data["questions"].each_with_index do |q, index| %>
    <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc;">
      <p><strong>Question <%= index + 1 %>:</strong> <%= q["question_text"] %></p>
      <ul>
        <% q["choices_text"].each_with_index do |choice, i| %>
          <li>
            <input type="radio" name="q<%= index %>" value="<%= i %>" id="q<%= index %>_choice<%= i %>">
            <label for="q<%= index %>_choice<%= i %>"><%= choice %></label>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>

<script>
  console.log("inline timer script loaded");

  let timerInterval;
  let totalSeconds = 0;

  function startTimer() {
    console.log("startTimer() called!");
    timerInterval = setInterval(() => {
      totalSeconds++;
      document.getElementById("study_seconds").value = totalSeconds;

      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;

      document.getElementById("timer").textContent =
        String(minutes).padStart(2, "0") + ":" +
        String(seconds).padStart(2, "0");
    }, 1000);
  }

  function stopTimer() {
    console.log("stopTimer() called!");
    clearInterval(timerInterval);
  }

  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOMContentLoaded fired", window.Chart)
  });
  document.addEventListener("turbo:load", () => {
    console.log("turbo:load fired", window.Chart)
    startTimer();
  });
</script>

  <%= f.submit "解説を見る" %>
<% end %>
