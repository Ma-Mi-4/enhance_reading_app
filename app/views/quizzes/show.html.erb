<% content_for :body_attributes do %> data-has-timer="true" data-turbo="false" <% end %>

<h1><%= @quiz_set.title %></h1>

<%= form_with url: explanation_quiz_path(@quiz_set),
              method: :post,
              local: true,
              html: { id: "quiz_form" },
              data: { turbo: false },
              onsubmit: "stopTimer(); calculateAccuracy(); return true;" do |f| %>

  <div id="timer">00:00</div>
  <%= hidden_field_tag :study_seconds, 0, id: "study_seconds" %>
  <%= hidden_field_tag :accuracy, 0, id: "accuracy_field_quiz" %>

  <% @quiz_questions.each_with_index do |q, index| %>
    <div class="question" style="margin-bottom:20px;">
      <p><strong><%= index + 1 %>. <%= q.question_text %></strong></p>

      <ul>
        <% q.choices_text.each_with_index do |choice, i| %>
          <li>
            <input type="radio"
                   name="q<%= index %>"
                   value="<%= i %>"
                   id="q<%= index %>_choice<%= i %>">
            <label for="q<%= index %>_choice<%= i %>"><%= choice %></label>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>

<script>
  let timerInterval;
  let totalSeconds = 0;

  function startTimer() {
    timerInterval = setInterval(() => {
      totalSeconds++;
      document.getElementById("study_seconds").value = totalSeconds;

      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;

      document.getElementById("timer").textContent =
        String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
    }, 1000);
  }

  function stopTimer() {
    clearInterval(timerInterval);
  }

  const correctIndexes = <%= raw @quiz_questions.map(&:correct_index).to_json %>;

  function calculateAccuracy() {
    let correctCount = 0;
    const form = document.getElementById("quiz_form");

    correctIndexes.forEach((correct, i) => {
      const selected = form.querySelector(`input[name="q${i}"]:checked`);
      if (selected && parseInt(selected.value) === correct) {
        correctCount++;
      }
    });

    const accuracy = correctCount / correctIndexes.length;
    document.getElementById("accuracy_field_quiz").value = accuracy;
  }

  function initQuiz() {
    startTimer();
  }

  document.addEventListener("DOMContentLoaded", initQuiz);
  document.addEventListener("turbo:load", initQuiz);
</script>

  <%= f.submit "解説を見る" %>
<% end %>
