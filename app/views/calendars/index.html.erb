<meta name="turbo-cache-control" content="no-cache">

<h1><%= @date.strftime('%Y年%m月') %></h1>

<div style="margin-bottom: 16px;">
  <%= link_to "前の月", calendars_path(month: @date.prev_month), class: "btn btn-secondary" %>
  <%= link_to "次の月", calendars_path(month: @date.next_month), class: "btn btn-secondary" %>
</div>

<div class="dashboard">
  <!-- カレンダー -->
  <div class="calendar-container">
    <table class="calendar-table">
      <tr>
        <% ['日','月','火','水','木','金','土'].each_with_index do |d,i| %>
          <th style="<%= 'color:red;' if i == 0 %><%= 'color:blue;' if i == 6 %>"><%= d %></th>
        <% end %>
      </tr>

      <% @first_wday.times do %>
        <td></td>
      <% end %>

      <% @days.each do |current_date| %>
        <td>
          <%= link_to current_date.day, calendar_day_path(date: current_date), class: "calendar-day-link" %>
        </td>
        <% if current_date.saturday? %></tr><tr><% end %>
      <% end %>
    </table>
  </div>

  <!-- 学習グラフ -->
  <div class="study-container">
    <h2>今週の学習時間・予想スコア</h2>
    <canvas id="studyChart"
        data-study='<%= raw(@study_data.to_json) %>'>
    </canvas>

    <!-- 今月の集計表示 -->
    <div class="month-summary" style="margin-top:16px;">
      <p>今月の学習時間合計: <%= @month_summary[:total_duration] %> 分</p>
      <p>今月の正答率: <%= @month_summary[:average_accuracy] %> %</p>
      <p>今月の予想スコア: <%= @month_summary[:predicted_score] %> 点</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("turbo:load", () => {
  const canvas = document.getElementById("studyChart");
  if (!canvas) return;

  const parsed = JSON.parse(canvas.dataset.study);

  console.log("Parsed study data:", parsed);
  parsed.forEach(d => {
    console.log(`Date: ${d.label}, Minutes: ${d.minutes}, Predicted Score: ${d.predicted_score}`);
  });

  const labels = parsed.map(d => d.label);
  const durations = parsed.map(d => d.minutes);
  const predicted_scores = parsed.map(d => d.predicted_score);

  console.log("Labels:", labels);
  console.log("Durations:", durations);
  console.log("Predicted Scores:", predicted_scores);

  if (canvas.chartInstance) canvas.chartInstance.destroy();

  canvas.chartInstance = new Chart(canvas, {
    data: {
      labels: labels,
      datasets: [
        {
          label: "学習時間（分）",
          data: durations,
          type: "bar",
          backgroundColor: "rgba(54, 162, 235, 0.5)",
          yAxisID: "y"
        },
        {
          label: "予想スコア",
          data: predicted_scores,
          type: "line",
          borderColor: "rgba(255, 99, 132, 1)",
          backgroundColor: "rgba(255, 99, 132, 0.2)",
          yAxisID: "y1",
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      stacked: false,
      scales: {
        y: { 
          type: "linear", 
          position: "left", 
          title: { display: true, text: "学習時間（分）" } 
        },
        y1: { 
          type: "linear", 
          position: "right", 
          title: { display: true, text: "予想スコア" },
          min: 500, max: 800, ticks: { stepSize: 50 }, 
          grid: { drawOnChartArea: false } 
        }
      }
    }
  });
});
</script>

<br>
<%= link_to "メイン画面へ戻る", main_path, class: "btn btn-primary" %>

