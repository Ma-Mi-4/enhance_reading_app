<h1><%= @date.strftime('%Y年%m月') %></h1>

<div style="margin-bottom: 16px;">
  <%= link_to "前の月", calendars_path(month: @date.prev_month), class: "btn btn-secondary" %>
  <%= link_to "次の月", calendars_path(month: @date.next_month), class: "btn btn-secondary" %>
</div>

<div class="dashboard">
  <div class="calendar-container">
    <table class="calendar-table">
      <tr>
        <% ['日','月','火','水','木','金','土'].each_with_index do |d,i| %>
          <th style="<%= 'color:red;' if i == 0 %><%= 'color:blue;' if i == 6 %>"><%= d %></th>
        <% end %>
      </tr>

      <% @first_wday.times do %>
        <td></td>
      <% end %>

      <% @days.each do |current_date| %>
        <td>
          <%= link_to current_date.day, calendar_day_path(date: current_date), class: "calendar-day-link" %>
        </td>
        <% if current_date.saturday? %></tr><tr><% end %>
      <% end %>
    </table>
  </div>

  <div class="study-container">
    <h2>学習時間（分）</h2>
    <!-- Canvas の高さは属性で固定 -->
    <canvas id="studyChart" width="800" height="250"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("turbo:load", function() {
  const ctx = document.getElementById("studyChart");
  if (!ctx) return;

  const dataMax = Math.max(...<%= raw @data.to_json %>);
  // Y軸の上限を調整（最大 60分に固定など）
  const yMax = Math.max(60, Math.ceil(dataMax / 10) * 10);

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: <%= raw @labels.to_json %>,
      datasets: [{
        label: "学習時間（分）",
        data: <%= raw @data.to_json %>,
        backgroundColor: "rgba(54, 162, 235, 0.5)",
        borderWidth: 1
      }]
    },
    options: { 
      maintainAspectRatio: false, // 親要素に依存せず高さ固定
      scales: { 
        y: { 
          beginAtZero: true,
          max: yMax
        } 
      },
      responsive: true
    }
  });
});
</script>

<br>
<%= link_to "メイン画面へ戻る", main_path, class: "btn btn-primary" %>
